<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapa 3D Los Angeles com Tráfego, Clima e Orbit</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>

<style>
  html, body { margin:0; padding:0; height:100%; width:100%; overflow:hidden; }
  #map { position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; }
  #controls {
    position:absolute; top:10px; left:10px;
    background: rgba(255,255,255,0.8); padding:10px; border-radius:6px;
    z-index:10; display:flex; flex-direction:column; gap:8px;
  }
  #controls button { padding:8px 16px; font-size:14px; cursor:pointer; border:1px solid #888; border-radius:4px; background:#fff; }
  #controls button:hover { background:#f0f0f0; }
  @media (max-width:600px){
    #controls { top:5px; left:5px; padding:6px; gap:6px; }
    #controls button { padding:6px 12px; font-size:12px; }
  }
</style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <button id="btnRefresh">Atualizar Mapa</button>
  <button id="btnOrbit">Orbit 3D (Pressione e arraste)</button>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYnJ1bm9wcmF4ZWRlczIxIiwiYSI6ImNtZmgzZWZjcjA3NjYyam9sZ3Jhc2Rld2sifQ.RTM-gBIflY5Y6ynbb19VFQ';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/brunopraxedes21/cmfhfvlyv007r01qw4xauaoes', 
  center: [-118.3241, 34.0313],
  zoom: 14,
  pitch: 60,
  bearing: -17.6,
  projection: 'mercator',
  antialias: true
});

// Controles de navegação
map.addControl(new mapboxgl.NavigationControl({ showCompass:true, showZoom:true }), 'top-right');
map.touchZoomRotate.enableRotation();

// Camada de tráfego
map.on('load', () => {
  map.addSource('traffic', {
    type: 'vector',
    url: 'mapbox://mapbox.mapbox-traffic-v1'
  });

  map.addLayer({
    id: 'traffic-flow',
    type: 'line',
    source: 'traffic',
    'source-layer': 'traffic',
    layout: { 'line-join': 'round', 'line-cap': 'round' },
    paint: {
      'line-color': [
        'match',
        ['get', 'congestion'],
        ['low'], '#00FF00',
        ['moderate'], '#FFFF00',
        ['heavy'], '#FF0000',
        ['severe'], '#8B0000',
        '#00FF00'
      ],
      'line-width': 3
    }
  });

  // API de clima - nuvens e chuva
  fetch('https://api.weatherapi.com/v1/current.json?key=zpka_73601477e5654df5a4c388da4183b5b6_5a2b7f5a&q=34.0313,-118.3241&aqi=no')
    .then(res => res.json())
    .then(data => {
      const clima = data.current.condition.text.toLowerCase();
      if(clima.includes('rain') || clima.includes('storm')){
        addRain();
      } else if(clima.includes('cloud')){
        addClouds();
      }
    });

  function addRain(){
    const rainDiv = document.createElement('div');
    rainDiv.style.position = 'absolute';
    rainDiv.style.top = '0';
    rainDiv.style.left = '0';
    rainDiv.style.width = '100%';
    rainDiv.style.height = '100%';
    rainDiv.style.pointerEvents = 'none';
    rainDiv.style.background = 'url(https://i.ibb.co/LvW8Z6K/rain.gif) repeat';
    rainDiv.style.opacity = '0.5';
    document.body.appendChild(rainDiv);
  }

  function addClouds(){
    const cloudDiv = document.createElement('div');
    cloudDiv.style.position = 'absolute';
    cloudDiv.style.top = '0';
    cloudDiv.style.left = '0';
    cloudDiv.style.width = '100%';
    cloudDiv.style.height = '100%';
    cloudDiv.style.pointerEvents = 'none';
    cloudDiv.style.background = 'url(https://i.ibb.co/mNqH9rM/clouds.png) repeat';
    cloudDiv.style.opacity = '0.4';
    document.body.appendChild(cloudDiv);
  }
});

// Botão Atualizar
document.getElementById("btnRefresh").addEventListener("click", () => {
  map.setCenter([-118.3241, 34.0313]);
  map.setZoom(14);
  map.setPitch(60);
  map.setBearing(-17.6);
});

// ===== Orbit =====
let orbitActive = false;
let lastMouse = null;
const orbitButton = document.getElementById("btnOrbit");

function startOrbit(e){ orbitActive=true; lastMouse=e.touches?e.touches[0]:e; }
function stopOrbit(){ orbitActive=false; lastMouse=null; }
function moveCamera(e){
  if(!orbitActive) return;
  let current = e.touches?e.touches[0]:e;
  const deltaX = current.clientX - lastMouse.clientX;
  const deltaY = current.clientY - lastMouse.clientY;
  const bearing = map.getBearing() + deltaX*0.1;
  let pitch = map.getPitch() - deltaY*0.1;
  pitch = Math.max(0, Math.min(85, pitch));
  map.setBearing(bearing);
  map.setPitch(pitch);
  lastMouse = current;
}
orbitButton.addEventListener('mousedown', startOrbit);
orbitButton.addEventListener('touchstart', startOrbit);
document.addEventListener('mouseup', stopOrbit);
document.addEventListener('touchend', stopOrbit);
document.addEventListener('mousemove', moveCamera);
document.addEventListener('touchmove', moveCamera);
</script>

</body>
</html>

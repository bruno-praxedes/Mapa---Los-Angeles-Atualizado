<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Mapa com relevo real + modelo GLB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>

<!-- Three.js + GLTFLoader -->
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
  html,body { margin:0; padding:0; height:100%; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #controls {
    position: absolute; top:10px; left:10px; z-index: 10;
    background: rgba(255,255,255,0.8); padding:6px 10px; border-radius:6px;
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="controls">
  <button id="btnReset">Resetar Vista</button>
</div>

<script>
mapboxgl.accessToken = "pk.eyJ1IjoiYnJ1bm9wcmF4ZWRlczIxIiwiYSI6ImNtZmgzZWZjcjA3NjYyam9sZ3Jhc2Rld2sifQ.RTM-gBIflY5Y6ynbb19VFQ";

const MODEL_LNG = -118.3605277778; // Los Angeles
const MODEL_LAT = 34.01375;

// Inicia mapa
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/standard',
  center: [MODEL_LNG, MODEL_LAT],
  zoom: 16,
  pitch: 60,
  bearing: -20,
  antialias: true
});

map.addControl(new mapboxgl.NavigationControl({ showZoom:true, showCompass:true }));

map.on('style.load', () => {
  // Ativar relevo real
  map.addSource('mapbox-dem', {
    "type": "raster-dem",
    "url": "mapbox://mapbox.terrain-rgb",
    "tileSize": 512,
    "maxzoom": 14
  });
  map.setTerrain({ "source": "mapbox-dem", "exaggeration": 1.2 });

  // Céu (atmosfera realista)
  map.addLayer({
    "id": "sky",
    "type": "sky",
    "paint": {
      "sky-type": "atmosphere",
      "sky-atmosphere-sun": [0.0, 0.0],
      "sky-atmosphere-sun-intensity": 15
    }
  });

  /* === Adicionar GLB === */
  const modelAltitude = 0; // em metros
  const mercatorCoord = mapboxgl.MercatorCoordinate.fromLngLat(
    [MODEL_LNG, MODEL_LAT],
    modelAltitude
  );

  const meterScale = mercatorCoord.meterInMercatorCoordinateUnits();

  // Aumentei bastante o multiplicador (ajuste se necessário)
  const MULTIPLICADOR_SCALE = 500.0;

  const modelTransform = {
    translateX: mercatorCoord.x,
    translateY: mercatorCoord.y,
    translateZ: mercatorCoord.z,
    scale: meterScale * MULTIPLICADOR_SCALE
  };

  const customLayer = {
    id: '3d-model',
    type: 'custom',
    renderingMode: '3d',
    onAdd: function (map, gl) {
      this.camera = new THREE.Camera();
      this.scene = new THREE.Scene();

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, -70, 100).normalize();
      this.scene.add(light);

      const loader = new THREE.GLTFLoader();
      loader.load(
        'casa.glb', // coloque o arquivo no mesmo diretório do index.html
        (gltf) => {
          this.model = gltf.scene;
          this.scene.add(this.model);
        },
        undefined,
        (err) => { console.error("Erro ao carregar casa.glb:", err); }
      );

      this.renderer = new THREE.WebGLRenderer({
        canvas: map.getCanvas(),
        context: gl,
        antialias: true
      });
      this.renderer.autoClear = false;
    },
    render: function (gl, matrix) {
      if (!this.model) return;

      const m = new THREE.Matrix4().fromArray(matrix);
      const l = new THREE.Matrix4()
        .makeTranslation(modelTransform.translateX, modelTransform.translateY, modelTransform.translateZ)
        .scale(new THREE.Vector3(modelTransform.scale, -modelTransform.scale, modelTransform.scale));

      this.camera.projectionMatrix = m.multiply(l);

      this.renderer.state.reset();
      this.renderer.render(this.scene, this.camera);
      map.triggerRepaint();
    }
  };

  map.addLayer(customLayer);
});

// Resetar câmera
document.getElementById('btnReset').addEventListener('click', () => {
  map.flyTo({ center: [MODEL_LNG, MODEL_LAT], zoom: 16, pitch: 60, bearing: -20 });
});
</script>

</body>
</html>

